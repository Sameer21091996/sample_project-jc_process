

{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block content_app %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Count Check</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .container {
            padding: 20px;
            max-width: 100%;
            margin: 0 auto;
            height: 100%;
            background-color: white;
            position: fixed;
        }
        .wrapper {
            position: fixed;
        }

                @media (min-width: 992px) {
            .sidebar-mini.sidebar-collapse .content-wrapper, .sidebar-mini.sidebar-collapse .main-footer, .sidebar-mini.sidebar-collapse .main-header {
                margin-left: 0rem !important;
            }
        }

        .page-link {
            position: relative;
            display: block;
            padding: .5rem .75rem;
            margin-left: -1px;
            line-height: 1.25;
            color: #323d89;
            background-color: #fff;
            border: 1px solid #dee2e6;
        }

        .scrollable-container {
            max-height: calc(100vh - 250px);
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: white;
            position: relative;
        }

        .assignment-table {
            width: 100%;
            border-collapse: collapse !important;
            border: 1px solid #dee2e6 !important;
        }

        .assignment-table th {
            background-color: #323d89;
            color: white;
            padding: 5px;
            font-weight: bold;
            border-right: 1px solid #ffffff30;
            font-size: 14px;
            border-collapse: collapse !important;
            border: 1px solid #dee2e6 !important;
        }

        .assignment-table td {
            border-collapse: collapse !important;
            border: 1px solid #dee2e6 !important;
            padding: 5px;
            text-align: left;
            font-size: 14px;
        }

        .assignment-table tr:hover {
            background-color: #f5f5f5;
        }

        .complete {
            background: #323d89;
            color: #ffffff;
            border-radius: 4px;
            padding: 8px 15px;
            font-size: 16px;
            margin-top: 2rem;
            float: right;
            cursor: pointer;
            border: none;
            margin-right: 10px;
        }

        .heading {
            font-size: 24px;
            margin-bottom: 20px;
        }

        hr.solid {
            border-top: 3px solid #bbb;
            margin-bottom: 20px;
        }

        /* .search-container {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            position: relative;
            width: fit-content;
        } */

        /* .search-input {
            padding: 8px 12px 8px 35px;
            width: 300px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 14px;
            margin-right: 10px;
        }

        .search-input:focus {
            outline: none;
            border-color: #323d89;
            box-shadow: 0 0 0 2px rgba(11, 122, 220, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #323d89;
        } */

        .status-filters {
            margin: 20px 0;
            gap: 4px;
            display: flex;
            align-items: center;
        }

        .status-btn {
            padding: 5px;
            border: 1px solid black;
            border-radius: 4px;
            cursor: pointer;
            background-color: #f0f0f0;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .status-btn.active {
            background-color: #323d89;
            color: white;
        }

        #count-all,
        #count-pending,
        #count-progress,
        #count-completed {
            background-color: #28a745;
            color: white;
            padding: 2px 5px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 12px;
        }

        .pagination-container {
            margin-top: 20px;
            margin-right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            bottom: 0;
            background: white;
            padding: 10px;
            border-top: 1px solid #dee2e6;
            z-index: 10;
        }

        #itemDropdown {
            margin-left: 10px;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 14px;
            width: 250px;
        }

        #itemDropdown:focus {
            outline: none;
            border-color: #323d89;
            box-shadow: 0 0 0 2px rgba(11, 122, 220, 0.1);
        }

        #itemList {
            max-height: 150px;
            /* Height of approximately 4 items */
            overflow-y: auto;
        }

        /* Style for the datalist options */
        option {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
        }

        /* Custom scrollbar styling */
        .custom-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            width: 300px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        #itemList {
            max-height: 150px;
            overflow-y: auto;
            margin: 0;
            padding: 0;
            list-style: none;
        }

        #itemList li {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
        }

        #itemList li:hover {
            background-color: #f5f5f5;
        }

        #itemList::-webkit-scrollbar {
            width: 8px;
        }

        #itemList::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        #itemList::-webkit-scrollbar-thumb {
            background: #323d89;
            border-radius: 4px;
        }

        #itemList::-webkit-scrollbar-thumb:hover {
            background: #095fb0;
        }

        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .media-item {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.2s;
            position: relative;
        }

        .media-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .media-content {
            position: relative;
            padding-top: 75%;
        }

        .media-content img,
        .media-content video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }

        .media-content video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-info {
            padding: 12px;
            background: white;
        }

        .media-info h4 {
            margin: 0;
            font-size: 14px;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .filter-btn {
            background: #f0f0f0;
            border: none;
            padding: 8px 16px;
            margin-right: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn.active {
            background: #323d89;
            color: white;
        }

        .play-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .play-overlay:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: translate(-50%, -50%) scale(1.1);
        }

        .media-item[data-type="videos"] .media-content:hover .play-overlay {
            background: rgba(0, 0, 0, 0.8);
        }

        .fullscreen-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .fullscreen-viewer img,
        .fullscreen-viewer video {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .close-viewer {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }

        .media-actions {
            display: flex;
            justify-content: flex-end;
            padding: 8px;
            border-top: 1px solid #eee;
        }

        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background-color: #323d89;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .download-btn:hover {
            background-color: #252d66;
            text-decoration: none;
            color: white;
        }

        .media-info {
            display: flex;
            flex-direction: column;
        }

        .media-info h4 {
            padding: 8px;
            margin: 0;
        }

        .column-selector-container {
            margin: 20px 0;
            position: relative;
            display: flex;
            gap: 10px;
        }

        .btn-customize-columns {
            background: #f0f0f0;
            border: 1px solid black;
            padding: 5px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        

        .btn-stock-count {
            background: #f0f0f0;
            border: 1px solid black;
            padding: 5px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .column-radio {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .btn-customize-columns:hover {
            background: #e9ecef;
        }

        .column-selector-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 300px;
            z-index: 1000;
        }

        .column-selector-header {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
        }

        .column-selector-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .column-selector-body {
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
        }

        .column-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .column-selector-footer {
            padding: 15px;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-apply {
            background: #007bff;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .complete:disabled {
            background-color: #cccccc;
            border-color: #999999;
            cursor: not-allowed;
        }

        .count-badge {
        background-color: #28a745;
        color: white;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 12px;
        margin-left: 5px;
        display: inline-block;
        min-width: 20px;
        text-align: center;
    }
    .selected-stock-count {
    background-color: #6995e7 !important;
}

.assignment-table td.selected-stock-count,
.assignment-table th.selected-stock-count {
    background-color: #6995e7 !important;
}

.initial-count-again {
    background: #323d89;
    color: #ffffff;
    border-radius: 4px;
    padding: 8px 15px;
    font-size: 16px;
    margin-top: 2rem;
    margin-right: 10px;
    float: right;
    cursor: pointer;
    border: none;
}


.stock-count-selector-container{
    display: flex;
}

.scrollable-container {
    position: relative;
    overflow-x: auto;
    margin-right: 20px;
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE and Edge */
}

.scrollable-container::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Opera */
}

#historyTable {
    width: max-content;
    min-width: 100%;
}

#historyTable th:first-child,
#historyTable td:first-child {
    position: sticky;
    left: 0;
    z-index: 10;
    background-color: #323d89;
    min-width: 150px;
}

#historyTable td:first-child {
    background-color: white;
}

#historyTable thead th {
    white-space: nowrap;
    min-width: 120px;
}

#historyTable tbody td {
    white-space: nowrap;
    min-width: 120px;
}




.save {
    background: #323d89;  /* Different color to distinguish from Complete button */
    color: #ffffff;
    border-radius: 4px;
    padding: 8px 15px;
    font-size: 16px;
    margin-top: 2rem;
    float: right;
    cursor: pointer;
    border: none;
    margin-right: 10px;
}

.save:disabled {
    background-color: #cccccc;
    border-color: #999999;
    cursor: not-allowed;
}

/* Add styles for history columns */
.history-column {
    background-color: #f8f9fa;
    border-left: 1px solid #dee2e6;
}

.history-column:nth-child(3n+1) {
    border-left: 2px solid #dee2e6;
}

thead th.history-column {
    background-color: #8086ab;
    text-align: center;
}

tbody td.history-column {
    color: #041425;
    font-size: 0.9em;
}
.scrollable-container {
    width: 100%;
    overflow-x: auto;
    margin-bottom: 20px;
    position: relative;
}

.assignment-table {
    min-width: 100%;
    width: max-content;  /* Allows table to expand beyond container */
    border-collapse: collapse;
}

/* Keep important columns visible while scrolling */
.sticky-left {
    position: sticky;
    left: 0;
    background: white;
    z-index: 2;
    border-right: 1px solid #ddd;
}

/* Add shadow effect for better visual separation */
.sticky-left::after {
    content: '';
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: linear-gradient(to right, rgba(0,0,0,0.1), transparent);
}


    </style>
</head>

<body>
    <div class="container">
        <h1 class="heading" id="pageTitle">Stock Count Check</h1>
        <div class="status-filters">
            <button class="status-btn active" data-status="all">All</button>
            <button class="status-btn" data-status="draft">Draft</button>
            <button class="status-btn" data-status="counting">Counting Done</button>
            <button class="status-btn" data-status="completed">Completed</button>
        </div>
        <hr class="solid">

        <div class="column-selector-container">
            
            <button class="btn-customize-columns" onclick="toggleColumnSelector()">
                <i class="fas fa-columns"></i> Customize Columns
            </button>
            <div id="columnSelectorDropdown" class="column-selector-dropdown" style="display: none;">
                <div class="column-selector-header">
                    <h4>Select Columns to Display</h4>
                    <div class="column-selector-actions">
                        <button onclick="selectAllColumns()">Select All</button>
                        <button onclick="deselectAllColumns()">Deselect All</button>
                    </div>
                </div>
                <div class="column-selector-body">
                    <!-- Columns will be populated here -->
                </div>
                <div class="column-selector-footer">
                    <button onclick="applyColumnSelection()" class="btn-apply">Apply</button>
                    <button onclick="toggleColumnSelector()" class="btn-cancel">Cancel</button>
                </div>
            </div>
            <div class="stock-count-selector-container">
                <button class="btn-stock-count" onclick="toggleStockCountSelector()">
                    <i class="fas fa-calculator"></i> Select Stock Count Column
                </button>
              
                <div id="stockCountSelectorDropdown" class="column-selector-dropdown" style="display: none;">
                    <div class="column-selector-header">
                        <h4>Select Stock Count Column</h4>
                    </div>
                    <div class="stock-count-selector-body">
                        <!-- Radio buttons will be populated here -->
                    </div>
                    <div class="column-selector-footer">
                        <button onclick="applyStockCountSelection()" class="btn-apply">Apply</button>
                        <button onclick="toggleStockCountSelector()" class="btn-cancel">Cancel</button>
                    </div>
                </div>
            </div>  
            <!-- <span id="selectedColumnText" class="selected-column-text"></span>           -->
        </div>





        <div class="scrollable-container">
            <table class="assignment-table" id="sccTable" >
                <thead id="sccTableHeader">
                </thead>
                <tbody id="sccTableBody">
                </tbody>
            </table>

            <table class="assignment-table" id="ibpTable" style="display: none;">
                <thead>
                    <tr id="ibpTableHeader">
                    </tr>
                </thead>
                <tbody id="ibpTableBody">
                </tbody>
            </table>
            <table class="assignment-table" id="historyTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Stock Count</th>
                        <th>Actual Count</th>
                        <th>Variance</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                </tbody>
            </table>
        </div>
        <div class="pagination-container">
            <div class="pagination-info">
                Showing <span id="showingStart">0</span> to <span id="showingEnd">0</span> of <span
                    id="totalEntries">0</span> entries
            </div>
            <nav aria-label="Table pagination">
                <ul class="pagination justify-content-end">
                    <li class="page-item">
                        <a class="page-link" href="#" id="prevPage">Previous</a>
                    </li>
                    <li class="page-item">
                        <select id="pageSize" class="form-control">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                        </select>
                    </li>
                    <li class="page-item">
                        <span class="page-link" id="pageInfo">Page 1 of 1</span>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="#" id="nextPage">Next</a>
                    </li>
                </ul>
            </nav>
        </div>
        <div style="padding: 20px; gap: 5px;">
            <button class="complete">Complete</button>
            <button class="save">Save</button>
            <!-- <button class="initial-count-again">Initial Count Again</button> -->
        </div>


    </div>
    <div id="mediaModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000;">
        <div
            style="position: relative; width: 95%; height: 95%; margin: 1% auto; background: #f8f9fa; padding: 20px; border-radius: 12px; overflow-y: auto;">
            <!-- for downloading media -->
            <div class="modal-header"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <h2 style="color: #333; margin: 0;">Media Gallery</h2>
                    <button onclick="downloadAllMedia()"
                        style="background: #323d89; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                        <i class="fas fa-download"></i> Download All
                    </button>
                </div>
                <button onclick="closeModal()"
                    style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                    Close
                </button>
            </div>

            <div class="media-filters" style="margin-bottom: 20px;">
                <button onclick="filterMedia('all')" class="filter-btn active">All</button>
                <button onclick="filterMedia('images')" class="filter-btn">Images</button>
                <button onclick="filterMedia('videos')" class="filter-btn">Videos</button>
            </div>

            <div id="mediaGrid" class="media-grid"></div>
        </div>
    </div>


    <script>



        function showLoader() {
            Swal.showLoading();
        }

        function hideLoader() {
            Swal.close();
        }


        const urlParams = new URLSearchParams(window.location.search);
        const updateType = urlParams.get('update_type');
        const headerId = urlParams.get('header_id');
        let selectedStockCountColumn = "Stock Count";
let numericColumns = [];

function initializeStockCountSelector(headerRow) {
    const selectorBody = document.querySelector('.stock-count-selector-body');
    
    // First check if data exists and has the expected structure
    if (!headerRow || !headerRow.data) {
        console.log('No header data available');
        return;
    }

    // Get numeric columns from the data rows
    numericColumns = Object.entries(headerRow.data)
        .filter(([_, value]) => {
            // Check if any corresponding data row has numeric values
            const rows = document.querySelectorAll('#sccTableBody tr');
            return Array.from(rows).some(row => {
                const cellValue = row.cells[parseInt(_.replace('attribute', '')) + 1]?.textContent;
                return cellValue && !isNaN(cellValue.trim());
            });
        })
        .map(([key, value]) => ({
            id: key,
            name: value.trim()
        }));

    console.log('Found numeric columns:', numericColumns);

    selectorBody.innerHTML = numericColumns.map(column => `
        <label class="column-radio">
            <input type="radio" 
                   name="stockCountColumn" 
                   value="${column.id}"
                   ${selectedStockCountColumn === column.name ? 'checked' : ''}>
            ${column.name}
        </label>
    `).join('');
}



async function applyStockCountSelection() {
    const selectedRadio = document.querySelector('input[name="stockCountColumn"]:checked');
    if (!selectedRadio) return;

    const columnName = numericColumns.find(col => col.id === selectedRadio.value).name;
    
    try {
        showLoader();
        const response = await fetch(`/api/stock/save-stock-count-column/${headerId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                column_name: columnName
            })
        });

        hideLoader();
        selectedStockCountColumn = columnName;
        
        const selectedColumnElement = document.getElementById('selectedColumnText');
        if (selectedColumnElement) {
            selectedColumnElement.textContent = `Current stock count column: ${columnName}`;
        }

        highlightSelectedColumn(columnName);
        toggleStockCountSelector();

        await Swal.fire({
            title: 'Success!',
            text: 'Stock count column updated successfully',
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
        });

    } catch (error) {
        hideLoader();
        console.error('Error:', error);
    }
}


function highlightSelectedColumn(columnName) {
    console.log("Highlighting column:", columnName); // Debug log
    
    // Clear existing highlights
    document.querySelectorAll('.selected-stock-count').forEach(el => {
        el.classList.remove('selected-stock-count');
    });

    // Find the exact column index
    const headerCells = document.querySelectorAll('#sccTable thead th');
    const columnIndex = Array.from(headerCells)
        .findIndex(cell => cell.textContent.trim() === columnName.trim());

    console.log("Found column index:", columnIndex); // Debug log

    if (columnIndex > -1) {
        // Apply highlighting to all cells in the column
        const table = document.querySelector('#sccTable');
        const rows = table.querySelectorAll('tr');
        
        rows.forEach(row => {
            const cell = row.cells[columnIndex];
            if (cell) {
                cell.classList.add('selected-stock-count');
            }
        });
    }
}


function toggleStockCountSelector() {
    const dropdown = document.getElementById('stockCountSelectorDropdown');
    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
}


function hasExistingCounts() {
    const rows = document.querySelectorAll('#sccTableBody tr');
    return Array.from(rows).some(row => {
        const actualCountCell = row.querySelector('.actual-count');
        const varianceCell = row.querySelector('td:nth-child(6)'); // Variance column
        const actualCountValue = actualCountCell?.textContent.trim();
        const varianceValue = varianceCell?.textContent.trim();
        return actualCountValue !== '' && actualCountValue !== '0' && 
               varianceValue !== '' && varianceValue !== '0';
    });
}

function updateStockCountButtonState() {
    const stockCountButton = document.querySelector('.btn-stock-count');
    if (hasExistingCounts()) {
        stockCountButton.disabled = true;
        stockCountButton.style.opacity = '0.5';
        stockCountButton.style.cursor = 'not-allowed';
    } else {
        stockCountButton.disabled = false;
        stockCountButton.style.opacity = '1';
        stockCountButton.style.cursor = 'pointer';
    }
}

function saveTableState(headerId) {
    const table = document.getElementById('sccTable');
    const tableState = {
        hasNewColumns: true,
        hiddenRows: Array.from(table.querySelectorAll('tr[style*="display: none"]'))
            .map(row => row.dataset.lineId),
        columnData: Array.from(table.querySelectorAll('tbody tr'))
            .filter(row => row.style.display !== 'none')
            .map(row => ({
                lineId: row.dataset.lineId,
                newColumns: Array.from(row.querySelectorAll('.new-count-set'))
                    .map(cell => ({
                        content: cell.textContent,
                        editable: cell.contentEditable
                    }))
            }))
    };
    localStorage.setItem(`table_state_${headerId}`, JSON.stringify(tableState));
}

let historyData = {};
        async function loadStockData() {
            try {
        
        
                // Get selected column first
                const columnResponse = await fetch(`/api/stock/get-stock-count-column/${headerId}`);
                const columnData = await columnResponse.json();
                const selectedColumn = columnData.column;
                console.log("Selected column from DB:", selectedColumn);

                const response = await fetch(`/api/stock/detail/${headerId}`);
                const data = await response.json();
                const countsResponse = await fetch(`/api/stock/detail/${headerId}/counts`);
                const counts = await countsResponse.json();
                // Get history data for all rows
                historyData = {};  // Reset history data
                for (const line of data.lines) {
                    if (!line.col_header_flag) {
                        const historyResponse = await fetch(`/api/stock/get-stock-count-history/${headerId}/${line.id}`);
                        const historyResult = await historyResponse.json();
                        if (historyResult.success) {
                            historyData[line.id] = historyResult.counts;
                        }
                    }
                }
                const currentData = localStorage.getItem(`current_data_${headerId}`);
                if (currentData !== JSON.stringify(data)) {
                    localStorage.removeItem(`cleared_lines_${headerId}`);
                    localStorage.setItem(`current_data_${headerId}`, JSON.stringify(data));
                }

                const allRecords = [...counts.records.draft, ...counts.records['in-progress'], ...counts.records.completed];
                // Check header status and disable Complete button if needed
                const completeButton = document.querySelector('.complete');
                if (data.header.status.toLowerCase() === 'completed') {
                    completeButton.disabled = true;
                    completeButton.style.opacity = '0.5';
                    completeButton.style.cursor = 'not-allowed';
                } else {
                    completeButton.disabled = false;
                    completeButton.style.opacity = '1';
                    completeButton.style.cursor = 'pointer';
                }
                const statusFilters = document.querySelector('.status-filters');
                if (data.header.upload_type_value === 'Item by publishing') {
                    const countDownBtn = statusFilters.querySelector('[data-status="in-progress"]');
                    if (countDownBtn) countDownBtn.remove();
                }

                // Update counts
                const countElements = {
                    'count-all': counts.total || 0,
                    'count-pending': counts.draft || 0,
                    'count-progress': counts['in-progress'] || 0,
                    'count-completed': counts.completed || 0
                };

                Object.entries(countElements).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                    }
                });

                if (data.header.upload_type_value === 'Stock count check') {
                    document.getElementById('pageTitle').textContent = 'Stock Count Check';
                    document.querySelectorAll('.status-btn').forEach(btn => {
                        btn.style.display = '';
                    });
                    const sccTable = document.getElementById('sccTable');
                    if (sccTable) sccTable.style.display = 'table';

                    const searchContainer = document.getElementById('searchContainer');
                    if (searchContainer) searchContainer.style.display = 'flex';

                    // Populate header
                    // Inside loadStockData function, replace the headerRow block with:
                     const headerRow = data.lines.find(line => line.col_header_flag);
                    if (headerRow) {
                        initializeColumnSelector(headerRow);
                initializeStockCountSelector(headerRow);
                
                if (selectedColumn && selectedColumn !== "Stock Count") {
                    const selectedColumnElement = document.getElementById('selectedColumnText');
                    if (selectedColumnElement) {
                        selectedColumnElement.textContent = `Current stock count column: ${selectedColumn}`;
                    }
                }
                
                const maxHistoryEntries = Math.max(...Object.values(historyData).map(counts => counts.length));
            
             //   const headerRow = data.lines.find(line => line.col_header_flag);
        const sccTableHeader = document.getElementById('sccTableHeader');
        
        if (sccTableHeader) {
            const columnOrder = getColumnOrder(headerRow);
            sccTableHeader.innerHTML = `
                <tr>
                    <th>ID</th>
                    <th>Status</th>
                    ${columnOrder.map(key => `<th>${headerRow.data[key] || ''}</th>`).join('')}
                    <th>Actual Count</th>
                    <th>Variance</th>
                    <th>Remarks</th>
                    ${Array(maxHistoryEntries).fill().map((_, index) => {
                        const firstLineHistories = Object.values(historyData)[0] || [];
                        const history = firstLineHistories[index] || {};
                        return `
                            <th colspan="3" class="history-column">
                                Count ${index + 1}<br>
                                <small>by ${history.created_by || ''}</small>
                            </th>
                        `;
                    }).join('')}

                </tr>
                <tr>
                    <th></th>
                    <th></th>
                    ${columnOrder.map(() => '<th></th>').join('')}
                    <th></th>
                    <th></th>
                    <th></th>
                    ${Array(maxHistoryEntries).fill().map(() => `
                        <th class="history-column">Actual</th>
                        <th class="history-column">Variance</th>
                        <th class="history-column">Remarks</th>
                    `).join('')}
                </tr>
            `;
        }

                    }


                    // Populate table body
                    populateTableBody(data.lines);
            updateStockCountButtonState();
            
            // Apply highlighting after table population
            if (selectedColumn && selectedColumn !== "Stock Count") {
                setTimeout(() => {
                    highlightSelectedColumn(selectedColumn);
                }, 100);
            }

                } else if (data.header.upload_type_value === 'Item by publishing') {
                    document.querySelector('.status-btn[data-status="counting"]').style.display = 'none';
                    const pageTitle = document.getElementById('pageTitle');
                    if (pageTitle) pageTitle.textContent = 'Item by Publishing';

                    const ibpTable = document.getElementById('ibpTable');
                    if (ibpTable) ibpTable.style.display = 'table';

                    const headerRow = data.lines.find(line => line.col_header_flag);
                    if (headerRow) {
                        initializeColumnSelector(headerRow);
                        const ibpTableHeader = document.getElementById('ibpTableHeader');
                        if (ibpTableHeader) {
                            ibpTableHeader.innerHTML = `
                                <th>ID</th>
                                <th>Status</th>
                                ${Object.values(headerRow.data).map(header => `<th>${header}</th>`).join('')}
                                <th>Attachments</th>
                            `;
                        }
                    }
                    populateIBPTable(data.lines);
                }

                updateStatusCounts();

            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function getColumnOrder(headerRow) {
            // Extract column order from header row data
            return Object.keys(headerRow.data)
                .sort((a, b) => {
                    // Sort by attribute number to maintain sequence
                    const numA = parseInt(a.replace('attribute', ''));
                    const numB = parseInt(b.replace('attribute', ''));
                    return numA - numB;
                });
        }

        
        function populateTableBody(lines) {
    const headerRow = lines.find(line => line.col_header_flag);
    const columnOrder = getColumnOrder(headerRow);
    const tbody = document.getElementById('sccTableBody');
    
    // Get max history entries
    const maxHistoryEntries = Math.max(
        ...Object.values(historyData || {}).map(counts => counts?.length || 0)
    );

    if (tbody && headerRow) {
        // Filter out non-header rows and map them to table rows
        tbody.innerHTML = lines
            .filter(record => !record.col_header_flag)
            .map(record => {
                const histories = historyData[record.id] || [];
                
                // Create main data columns
                const mainColumns = columnOrder
                    .map(key => `<td>${record.data[key] || ''}</td>`)
                    .join('');

                // Create history columns
                const historyColumns = Array(maxHistoryEntries)
                    .fill()
                    .map((_, index) => {
                        const history = histories[index] || {};
                        return `
                            <td class="history-column">${history.actual_count || ''}</td>
                            <td class="history-column">${history.variance || ''}</td>
                            <td class="history-column">${history.remarks || ''}</td>
                        `;
                    })
                    .join('');

                // Construct the complete row
                return `
                    <tr data-status="${record.line_status?.toLowerCase() || 'draft'}" 
                        data-line-id="${record.id}">
                        <td>${record.id}</td>
                        <td>${record.line_status || 'Draft'}</td>
                        ${mainColumns}
                        <td class="actual-count" contenteditable="true">${record.actual_count || ''}</td>
                        <td>${record.variance || ''}</td>
                        <td class="remarks" contenteditable="true">${record.remarks || ''}</td>
                        ${historyColumns}
                    </tr>
                `;
            })
            .join('');

        // Attach event listeners and update UI
        const tableRows = tbody.querySelectorAll('tr');
        attachActualCountListeners(tableRows);
        updateStockCountButtonState();

        // Initialize pagination
        const tablePagination = new TablePagination('#sccTable');
        tablePagination.updateRows(Array.from(tableRows));
        updateStatusCounts();
    }
}
document.querySelector('.save').addEventListener('click', async () => {
    const rows = document.querySelectorAll('#sccTableBody tr');
    const payload = [];

    rows.forEach(row => {
        // Get the line ID directly from the first cell
        const lineId = row.cells[0].textContent.trim();
        
        // Get actual count, variance and remarks
        const actualCountCell = row.querySelector('.actual-count');
        const varianceCell = row.querySelector('td:nth-child(6)');
        const remarksCell = row.querySelector('.remarks');

        payload.push({
            line_id: parseInt(lineId),
            actual_count: actualCountCell?.textContent.trim() || '0',
            variance: varianceCell?.textContent.trim() || '0',
            remarks: remarksCell?.textContent.trim() || ''
        });
    });

    try {
        showLoader();
        const response = await fetch(`/api/stock/update-stock-count/${headerId}?action=save`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            await loadStockData();
            Swal.fire({
                title: 'Success!',
                text: 'Stock count saved successfully',
                icon: 'success',
                timer: 2000
            });
        }
    } catch (error) {
        console.error('Save error:', error);
        Swal.fire({
            title: 'Error',
            text: 'Failed to save stock count',
            icon: 'error'
        });
    } finally {
        hideLoader();
    }
});


        document.querySelector('.complete').addEventListener('click', async () => {
            if (this.disabled) return;

            const rows = document.querySelectorAll('#sccTableBody tr');
            const payload = [];

            rows.forEach(row => {
                const cells = Array.from(row.cells);
                const headerCells = row.closest('table').querySelectorAll('thead th');

                const actualCountIndex = Array.from(headerCells).findIndex(th => th.textContent === 'Actual Count');
                const varianceIndex = Array.from(headerCells).findIndex(th => th.textContent === 'Variance');
                const remarksIndex = cells.length - 1;

                payload.push({
                    line_id: parseInt(row.dataset.lineId),
                    actual_count: cells[actualCountIndex].textContent,
                    variance: cells[varianceIndex].textContent,
                    remarks: cells[remarksIndex].textContent.trim()
                });
            });

            try {
                showLoader();
                const response = await fetch(`/api/stock/update-stock-count/${headerId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (result.success) {
                    alert('Stock count updated successfully');
                    setTimeout(() => {
                        loadStockData();
                        hideLoader();
                    }, 1000);
                } else {
                    hideLoader();
                    alert(result.message);
                }
            } catch (error) {
                hideLoader();
                alert('Error updating stock count');
                console.error(error);
            }
        });


        function populateSCCTable(lines) {
            const tbody = document.getElementById('sccTableBody');
            const filteredLines = lines.filter(line => !line.col_header_flag);

            tbody.innerHTML = filteredLines.map(line => `
            <tr data-status="${line.status || 'draft'}" data-line-id="${line.id}">
                ${Object.values(line.data).map(value => `<td>${value || ''}</td>`).join('')}
                <td contenteditable="true"></td>
                <td></td>
                <td contenteditable="true"></td>
            </tr>
        `).join('');

            const tablePagination = new TablePagination('#sccTable');
            const tableRows = tbody.querySelectorAll('tr');
            tablePagination.updateRows(Array.from(tableRows));

            // Add event listeners for Actual Count calculation
            tableRows.forEach(row => {
                const actualCountCell = row.querySelector('td:nth-child(5)');
                actualCountCell.addEventListener('input', () => {
                    const stockCount = parseInt(row.querySelector('td:nth-child(4)').textContent) || 0;
                    const actualCount = parseInt(actualCountCell.textContent) || 0;
                    const varianceCell = row.querySelector('td:nth-child(6)');
                    varianceCell.textContent = stockCount - actualCount;
                });
            });
            updateStatusCounts();
        }


        // Modify the table body to include the new columns


        function updateStatusCounts() {
    const sccRows = document.querySelectorAll('#sccTableBody tr');
    const ibpRows = document.querySelectorAll('#ibpTableBody tr');
    const allRows = [...sccRows, ...ibpRows];

    // Initialize counts
    const counts = {
        all: allRows.length,
        draft: 0,
        'counting done': 0,
        completed: 0
    };

    // Count records by status
    allRows.forEach(row => {
        const status = row.dataset.status.toLowerCase();
        if (status === 'counting done') {
            counts['counting done']++;
        } else if (counts.hasOwnProperty(status)) {
            counts[status]++;
        }
    });

    // Update count badges in buttons
    const statusButtons = document.querySelectorAll('.status-btn');
    statusButtons.forEach(button => {
        const status = button.dataset.status;

        const count = counts[status === 'counting' ? 'counting done' : status] || 0;
        const existingBadge = button.querySelector('.count-badge');
        
        if (existingBadge) {
            existingBadge.textContent = count;
        } else {
            const badge = document.createElement('span');
            badge.className = 'count-badge';
            badge.textContent = count;
            button.appendChild(badge);
        }
    });
}



        function populateIBPTable(lines) {
    const tbody = document.getElementById('ibpTableBody');
    const filteredLines = lines.filter(line => !line.col_header_flag);

    tbody.innerHTML = filteredLines.map(line => `
        <tr data-status="${line.line_status.toLowerCase()}">
            <td>${line.id}</td>
            <td>${line.line_status}</td>
            ${Object.values(line.data).map(value => `<td>${value || ''}</td>`).join('')}
            <td><a href="#" onclick="showMedia(${line.id}); return false;" class="view-link">View images/videos</a></td>
        </tr>
    `).join('');

    const tablePagination = new TablePagination('#ibpTable');
    const tableRows = tbody.querySelectorAll('tr');
    tablePagination.updateRows(Array.from(tableRows));
    updateStatusCounts();
}

        async function showMedia(lineId) {
            const modal = document.getElementById('mediaModal');
            const mediaGrid = document.getElementById('mediaGrid');
            modal.style.display = 'block';
            mediaGrid.innerHTML = '<div style="text-align: center; padding: 20px;">Loading media files...</div>';

            try {
                const response = await fetch(`/api/stock/media/${headerId}/${lineId}`);
                const mediaFiles = await response.json();

                if (mediaFiles.length === 0) {
                    mediaGrid.innerHTML = '<div style="text-align: center; padding: 20px;">No media files found</div>';
                    return;
                }

                mediaGrid.innerHTML = mediaFiles.map(file => {
                    if (file.type === 'images') {
                        return `
                    <div class="media-item" data-type="images">
                        <div class="media-content">
                            <img src="/media/${file.path}" alt="${file.file_name}" 
                                 onclick="openFullscreen('/media/${file.path}', 'image')">
                        </div>
                        <div class="media-info">
                            <h4>${file.file_name}</h4>
                            <div class="media-actions">
                                <a href="/media/${file.path}" 
                                   download="${file.file_name}"
                                   class="download-btn">
                                    <i class="fas fa-download"></i> Download
                                </a>
                            </div>
                        </div>
                    </div>
                `;
                    } else if (file.type === 'videos') {
                        return `
                    <div class="media-item" data-type="videos">
                        <div class="media-content">
                            <video id="video-${file.id}">
                                <source src="/media/${file.path}" type="video/mp4">
                            </video>
                            <div class="play-overlay" onclick="toggleVideo('video-${file.id}', this)">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="media-info">
                            <h4>${file.file_name}</h4>
                            <div class="media-actions">
                                <a href="/media/${file.path}" 
                                   download="${file.file_name}"
                                   class="download-btn">
                                    <i class="fas fa-download"></i> Download
                                </a>
                            </div>
                        </div>
                    </div>
                `;
                    }
                    return '';
                }).join('');

                document.querySelectorAll('video').forEach(video => {
                    video.addEventListener('ended', function () {
                        const playButton = this.parentElement.querySelector('.play-overlay');
                        if (playButton) {
                            playButton.style.display = 'flex';
                        }
                    });
                });

            } catch (error) {
                mediaGrid.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading media files</div>';
                console.error('Error:', error);
            }
        }

        function toggleVideo(videoId, playButton) {
            const video = document.getElementById(videoId);
            if (video.paused) {
                video.play();
                playButton.style.display = 'none';
            } else {
                video.pause();
                playButton.style.display = 'flex';
            }
        }

        function filterMedia(type) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.filter-btn[onclick="filterMedia('${type}')"]`).classList.add('active');

            document.querySelectorAll('.media-item').forEach(item => {
                if (type === 'all' || item.dataset.type === type) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function openFullscreen(path, type) {
            const viewer = document.createElement('div');
            viewer.className = 'fullscreen-viewer';

            const content = type === 'image'
                ? `<img src="${path}" alt="Fullscreen view">`
                : `<video src="${path}" controls autoplay style="max-width: 90%; max-height: 90%;"></video>`;

            viewer.innerHTML = `
        ${content}
        <div class="close-viewer" onclick="this.parentElement.remove()">×</div>
    `;

            document.body.appendChild(viewer);
        }

        function closeModal() {
            document.getElementById('mediaModal').style.display = 'none';
            const videos = document.querySelectorAll('video');
            videos.forEach(video => video.pause());
        }

        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('fullscreen-viewer')) {
                e.target.remove();
            }
        });

        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                const fullscreenViewer = document.querySelector('.fullscreen-viewer');
                if (fullscreenViewer) {
                    fullscreenViewer.remove();
                }
                closeModal();
            }
        });


        function initializeSearch() {
            const searchInput = document.getElementById('itemSearch');
            let searchTimeout;

            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(async () => {
                    const searchTerm = e.target.value.trim();

                    try {
                        const response = await fetch(`/api/stock/search/${headerId}?search_term=${encodeURIComponent(searchTerm)}`);
                        const data = await response.json();

                        const tbody = document.getElementById('sccTableBody');
                        tbody.innerHTML = data.lines.map(line => `
                    <tr data-status="${line.line_status.toLowerCase()}">
                        ${Object.values(line.data).map(value => `<td>${value || ''}</td>`).join('')}
                        <td contenteditable="true"></td>
                        <td></td>
                        <td contenteditable="true"></td>
                    </tr>
                `).join('');

                        const tablePagination = new TablePagination('#sccTable');
                        const tableRows = tbody.querySelectorAll('tr');
                        tablePagination.updateRows(Array.from(tableRows));
                        attachActualCountListeners(tableRows);

                    } catch (error) {
                        console.error('Error searching items:', error);
                    }
                }, 300);
            });
        }

        // Add event listener for actual count calculation
        function attachActualCountListeners(rows) {
            rows.forEach(row => {
                const stockCountCell = row.querySelector('td:nth-child(4)'); // Stock count column
                const actualCountCell = row.querySelector('td:nth-child(5)'); // Actual count column
                const varianceCell = row.querySelector('td:nth-child(6)'); // Variance column

                // Make actual count cell read-only
                actualCountCell.setAttribute('contenteditable', 'false');
                varianceCell.setAttribute('contenteditable', 'false');

                // Calculate variance when actual count changes
                actualCountCell.addEventListener('input', () => {
                    const stockCount = parseInt(stockCountCell.textContent) || 0;
                    const actualCount = parseInt(actualCountCell.textContent) || 0;
                    varianceCell.textContent = stockCount - actualCount;
                });
            });
        }



        document.addEventListener('DOMContentLoaded', () => {
            loadStockData();
            initializeSearch();
            updateStatusCounts();
        });

        class TablePagination {
            constructor(tableSelector, rowsPerPage = 10) {
                this.table = document.querySelector(tableSelector);
                this.rowsPerPage = rowsPerPage;
                this.currentPage = 1;
                this.rows = [];

                this.prevButton = document.getElementById('prevPage');
                this.nextButton = document.getElementById('nextPage');
                this.pageSizeSelect = document.getElementById('pageSize');
                this.pageInfo = document.getElementById('pageInfo');

                this.bindEvents();
            }

            updateRows(rows) {
                this.rows = rows;
                this.currentPage = 1;
                this.updateTable();

            }

            updateTable() {
                const start = (this.currentPage - 1) * this.rowsPerPage;
                const end = start + this.rowsPerPage;
                const totalPages = Math.ceil(this.rows.length / this.rowsPerPage);

                this.rows.forEach(row => {
                    row.style.display = 'none';
                });

                this.rows.slice(start, end).forEach(row => {
                    row.style.display = '';
                });

                this.updatePaginationControls(totalPages);
            }

            updatePaginationControls(totalPages) {
                const start = (this.currentPage - 1) * this.rowsPerPage + 1;
                const end = Math.min(start + this.rowsPerPage - 1, this.rows.length);
                const total = this.rows.length;
                document.getElementById('totalEntries').textContent = total;
                document.getElementById('showingStart').textContent = total ? 1 : 0;
                document.getElementById('showingEnd').textContent = Math.min(this.rowsPerPage, total);

                this.pageInfo.textContent = `Page ${this.currentPage} of ${totalPages}`;

                this.prevButton.parentElement.classList.toggle('disabled', this.currentPage <= 1);
                this.nextButton.parentElement.classList.toggle('disabled', this.currentPage >= totalPages);
            }

            bindEvents() {
                this.prevButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (this.currentPage > 1) {
                        this.currentPage--;
                        this.updateTable();
                    }
                });

                this.nextButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    const totalPages = Math.ceil(this.rows.length / this.rowsPerPage);
                    if (this.currentPage < totalPages) {
                        this.currentPage++;
                        this.updateTable();
                    }
                });

                this.pageSizeSelect.addEventListener('change', (e) => {
                    this.rowsPerPage = parseInt(e.target.value);
                    this.currentPage = 1;
                    this.updateTable();
                });
            }
        }

        // Initialize pagination and status filtering
        document.addEventListener('DOMContentLoaded', () => {
            const tablePagination = new TablePagination('#sccTable');

// Status filtering functionality
            const statusButtons = document.querySelectorAll('.status-btn');

            statusButtons.forEach(button => {
    button.addEventListener('click', () => {
        // Remove active class from all buttons
        statusButtons.forEach(btn => btn.classList.remove('active'));
        
        // Add active class to clicked button
        button.classList.add('active');
        
        // Get selected status
        const status = button.dataset.status;
        
        // Filter table rows for both SCC and IBP tables
        const sccRows = document.querySelectorAll('#sccTableBody tr');
        const ibpRows = document.querySelectorAll('#ibpTableBody tr');
        
        const filterRow = (row) => {
            if (status === 'all') {
                row.style.display = '';
            } else if (status === 'counting') {
                // Check for both 'counting' and 'counting done' status
                row.dataset.status === 'counting' || row.dataset.status === 'counting done' ? 
                    row.style.display = '' : 
                    row.style.display = 'none';
            } else {
                row.dataset.status === status ? 
                    row.style.display = '' : 
                    row.style.display = 'none';
            }
        };

        // Apply filtering to both tables
        sccRows.forEach(filterRow);
        ibpRows.forEach(filterRow);
    });
});

            function filterByStatus(status) {
                const isStockCount = document.getElementById('sccTable').style.display === 'table';
                const tableId = isStockCount ? '#sccTableBody' : '#ibpTableBody';

                fetch(`/api/stock/detail/${headerId}/counts`)
                    .then(response => response.json())
                    .then(data => {
                        const tbody = document.querySelector(tableId);
                        let filteredRecords = [];

                        if (status === 'all') {
                            filteredRecords = [...data.records.draft, ...data.records['in-progress'], ...data.records.completed];
                        } else if (status === 'pending') {
                            filteredRecords = data.records.draft;
                        } else if (status === 'in-progress') {
                            filteredRecords = data.records['in-progress'];
                        } else if (status === 'completed') {
                            filteredRecords = data.records.completed;
                        }

                        if (isStockCount) {
                            tbody.innerHTML = filteredRecords.map(record => {
                                return `
                        <tr data-status="${record.line_status.toLowerCase()}" data-line-id="${record.id}">
                            ${Object.entries(record.data)
                                        .filter(([key]) => !key.startsWith('_'))
                                        .map(([_, value]) => `<td>${value || ''}</td>`)
                                        .join('')}
                        </tr>
                    `;
                            }).join('');
                        } else {
                            tbody.innerHTML = filteredRecords.map(record => `
                                <tr data-status="${record.line_status.toLowerCase()}">
                                    ${Object.values(record.data).map(value => `<td>${value || ''}</td>`).join('')}
                                    <td><a href="#" class="view-link">View images/videos</a></td>
                                </tr>
                            `).join('');
                        }

                        const tablePagination = new TablePagination(isStockCount ? '#sccTable' : '#ibpTable');
                        const tableRows = tbody.querySelectorAll('tr');
                        tablePagination.updateRows(Array.from(tableRows));
                        if (isStockCount) {
                            attachActualCountListeners(tableRows);
                        }
                        updateStatusCounts();
                    });
            }


        });

        async function loadDropdownOptions() {
            try {
                const response = await fetch(`/api/stock/detail/${headerId}`);
                const data = await response.json();

                const uniqueItems = [...new Set(data.lines
                    .filter(line => !line.col_header_flag)
                    .map(line => line.data.attribute2)
                    .filter(Boolean))];

                const itemList = document.getElementById('itemList');
                const searchInput = document.getElementById('itemSearch');
                const dropdown = document.getElementById('customDropdown');

                function updateDropdownItems(filterText = '') {
                    const filteredItems = filterText
                        ? uniqueItems.filter(item =>
                            item.toLowerCase().includes(filterText.toLowerCase()))
                        : uniqueItems;

                    itemList.innerHTML = filteredItems.map(item => `
                <li>${item}</li>
            `).join('');

                    dropdown.style.display = filteredItems.length ? 'block' : 'none';
                }

                // Show all items on focus if input is empty
                searchInput.addEventListener('focus', () => {
                    if (!searchInput.value.trim()) {
                        updateDropdownItems();
                    }
                });

                // Filter items while typing
                searchInput.addEventListener('input', (e) => {
                    updateDropdownItems(e.target.value.trim());
                });

                // Handle clicks outside
                document.addEventListener('click', (e) => {
                    if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                        dropdown.style.display = 'none';
                    }
                });

                // Handle item selection
                itemList.addEventListener('click', (e) => {
                    if (e.target.tagName === 'LI') {
                        searchInput.value = e.target.textContent;
                        dropdown.style.display = 'none';
                        searchInput.dispatchEvent(new Event('input'));
                    }
                });

            } catch (error) {
                console.error('Error loading dropdown options:', error);
            }
        }

        // Add this to your DOMContentLoaded event
        document.addEventListener('DOMContentLoaded', () => {
            loadStockData();
            initializeSearch();
            loadDropdownOptions();
            updateStatusCounts(); // Add this line
        });


        async function downloadAllMedia() {
            try {
                const mediaItems = document.querySelectorAll('.media-item');

                if (mediaItems.length === 0) {
                    alert('No media files to download');
                    return;
                }

                for (const item of mediaItems) {
                    const downloadLink = item.querySelector('.download-btn');
                    if (downloadLink) {
                        const link = document.createElement('a');
                        link.href = downloadLink.href;
                        link.download = downloadLink.getAttribute('download');
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        // Add small delay between downloads
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }
            } catch (error) {
                console.error('Error downloading files:', error);
                alert('Error downloading files');
            }
        }


        let selectedColumns = new Set();
        let availableColumns = [];

        function initializeColumnSelector(headerRow) {
    const columnSelectorBody = document.querySelector('.column-selector-body');
    
    // Create array of column objects with proper indexing
    availableColumns = Object.entries(headerRow.data)
        .sort((a, b) => {
            const numA = parseInt(a[0].replace('attribute', ''));
            const numB = parseInt(b[0].replace('attribute', ''));
            return numA - numB;
        })
        .map(([key, value], index) => ({
            id: key,
            name: value,
            index: index + 2 // Add 2 to account for ID and Status columns
        }));

    // Initialize selected columns
    selectedColumns = new Set(availableColumns.map(col => col.id));

    // Populate column selector with sorted columns
    columnSelectorBody.innerHTML = availableColumns.map(column => `
        <label class="column-checkbox">
            <input type="checkbox"
                data-column-index="${column.index}"
                value="${column.id}"
                ${selectedColumns.has(column.id) ? 'checked' : ''}>
            ${column.name}
        </label>
    `).join('');

    // Add change event listeners
    columnSelectorBody.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
            if (e.target.checked) {
                selectedColumns.add(e.target.value);
            } else {
                selectedColumns.delete(e.target.value);
            }
        });
    });
}

function toggleColumnSelector() {
    const dropdown = document.getElementById('columnSelectorDropdown');
    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';

    // Close dropdown when clicking outside
    document.addEventListener('click', function closeDropdown(e) {
        const dropdown = document.getElementById('columnSelectorDropdown');
        const columnSelector = document.querySelector('.column-selector');
        
        if (!columnSelector.contains(e.target)) {
            dropdown.style.display = 'none';
            document.removeEventListener('click', closeDropdown);
        }
    });
}

function applyColumnSelection() {
    const table = document.getElementById('sccTable');
    const headerRow = table.querySelector('thead tr');
    const bodyRows = table.querySelectorAll('tbody tr');

    // Always show ID and Status columns (first two columns)
    const fixedColumns = 2;

    // Handle each column
    availableColumns.forEach(column => {
        const isSelected = selectedColumns.has(column.id);
        const columnIndex = column.index;

        // Update header visibility
        if (headerRow.cells[columnIndex]) {
            headerRow.cells[columnIndex].style.display = isSelected ? '' : 'none';
        }

        // Update data rows visibility
        bodyRows.forEach(row => {
            if (row.cells[columnIndex]) {
                row.cells[columnIndex].style.display = isSelected ? '' : 'none';
            }
        });
    });

    // Ensure fixed columns are always visible
    for (let i = 0; i < fixedColumns; i++) {
        if (headerRow.cells[i]) {
            headerRow.cells[i].style.display = '';
        }
        bodyRows.forEach(row => {
            if (row.cells[i]) {
                row.cells[i].style.display = '';
            }
        });
    }

    toggleColumnSelector();
}

function selectAllColumns() {
    const checkboxes = document.querySelectorAll('.column-checkbox input');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
        selectedColumns.add(checkbox.value);
    });
}

function deselectAllColumns() {
    const checkboxes = document.querySelectorAll('.column-checkbox input');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        selectedColumns.delete(checkbox.value);
    });
}


    </script>
</body>

</html>
{% endblock %}